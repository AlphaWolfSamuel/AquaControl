<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquarium Controller Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Fallback color in case image fails to load */
            background-color: #0a192f;
            /* Aquatic background image */
            background-image: url('https://images.unsplash.com/photo-1535441220208-a4a5fed15d2a?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .gauge-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 aspect ratio */
        }
        .gauge-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        /* Glassmorphism style for panels */
        .bg-glass {
            background-color: rgba(17, 24, 39, 0.7); /* bg-gray-900 with opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .bg-glass-darker {
             background-color: rgba(17, 24, 39, 0.8); /* Darker for modal */
             backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="dashboard-container" class="container mx-auto p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-cyan-300">AquaControl</h1>
                <p class="text-gray-300">Your Aquarium, Perfectly Managed.</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="connection-status" class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                    <span class="text-gray-400">Disconnected</span>
                </div>
                 <button id="reconnect-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 border border-cyan-400">
                    Connect
                </button>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">

            <!-- Sensor Readings Column -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- Temperature Gauge -->
                <div class="bg-glass p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-200 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>
                        Temperature
                    </h2>
                    <div class="gauge-container">
                        <canvas id="tempGauge" class="gauge-canvas"></canvas>
                    </div>
                    <p class="text-center text-3xl font-bold mt-2"><span id="temp-value">--</span>&deg;C</p>
                </div>

                <!-- pH Gauge -->
                <div class="bg-glass p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-200 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v2"/><path d="M12 2v2"/><path d="M16 2v2"/><path d="M7 22h10"/><path d="M5 12.34V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v6.34a6.5 6.5 0 0 1-2.9 5.66l-2.7 1.62a3.5 3.5 0 0 1-3.8 0l-2.7-1.62A6.5 6.5 0 0 1 5 12.34Z"/></svg>
                        pH Level
                    </h2>
                     <div class="gauge-container">
                        <canvas id="phGauge" class="gauge-canvas"></canvas>
                    </div>
                    <p class="text-center text-3xl font-bold mt-2"><span id="ph-value">--</span></p>
                </div>
            </div>
            
            <!-- Second Sensor Column -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                 <!-- TDS -->
                <div class="bg-glass p-4 rounded-xl shadow-lg text-center">
                    <h2 class="text-lg font-semibold text-gray-200 mb-2 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 2-5.5 5.5"/><path d="m20 10-5.5 5.5"/><path d="M2 12l5.5 5.5"/><path d="m10 20 5.5-5.5"/></svg>
                        TDS
                    </h2>
                    <p class="text-4xl font-bold text-cyan-300"><span id="tds-value">--</span> <span class="text-2xl text-gray-400">ppm</span></p>
                </div>
                 <!-- Ammonia -->
                <div class="bg-glass p-4 rounded-xl shadow-lg text-center">
                    <h2 class="text-lg font-semibold text-gray-200 mb-2 flex items-center justify-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m13 13-4 4"/><path d="m13.5 8.5-5 5"/><path d="m11 11-4 4"/><path d="m15 7-8 8"/></svg>
                        Ammonia (NHâ‚ƒ)
                    </h2>
                    <p class="text-4xl font-bold text-green-400"><span id="ammonia-value">--</span> <span class="text-2xl text-gray-400">ppm</span></p>
                </div>
                 <!-- Water Level -->
                <div class="bg-glass p-4 rounded-xl shadow-lg text-center">
                    <h2 class="text-lg font-semibold text-gray-200 mb-2 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"/></svg>
                        Water Level
                    </h2>
                    <p class="text-4xl font-bold text-cyan-300" id="water-level">--</p>
                </div>
            </div>

            <!-- Controls & History Column -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- Main Controls -->
                <div class="bg-glass p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-gray-200">System Controls</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Main Pump -->
                        <div class="flex items-center justify-between bg-gray-900/50 p-4 rounded-lg">
                            <span class="font-medium flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v10c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V7"/><path d="M2 12h20"/><path d="M12 2a4 4 0 0 0-4 4v4a4 4 0 0 0 8 0V6a4 4 0 0 0-4-4Z"/></svg>
                                Main Pump
                            </span>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer" id="pump-toggle">
                                <div class="relative w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-500"></div>
                            </label>
                        </div>
                        <!-- Feeder -->
                        <div class="flex items-center justify-between bg-gray-900/50 p-4 rounded-lg">
                             <span class="font-medium flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a2.95 2.95 0 0 1-2.1-5.1L15 11.8a2.95 2.95 0 0 1 5.1 2.1A2.95 2.95 0 0 1 18 16a2.95 2.95 0 0 1-2.1 5.1L10.8 16a2.95 2.95 0 0 1-2.9 2.9Z"/><path d="M22 12a2.95 2.95 0 0 1-5.1-2.1L11.8 15a2.95 2.95 0 0 1-2.1-5.1A2.95 2.95 0 0 1 12 8a2.95 2.95 0 0 1 5.1 2.1L16 15.2a2.95 2.95 0 0 1 2.9-2.9Z"/><path d="m15.2 10.8 1.6-2.7a3.5 3.5 0 0 0-5.8-2.2L8.1 8.1a3.5 3.5 0 0 0 2.2 5.8l2.7-1.6"/><path d="m8.8 13.2-1.6 2.7a3.5 3.5 0 0 0 5.8 2.2l2.9-2.9a3.5 3.5 0 0 0-2.2-5.8l-2.7 1.6"/></svg>
                                Auto Feeder
                            </span>
                             <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer" id="feeder-toggle">
                                <div class="relative w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-500"></div>
                            </label>
                        </div>
                         <!-- Heater Status -->
                        <div class="flex items-center justify-between bg-gray-900/50 p-4 rounded-lg sm:col-span-2">
                             <span class="font-medium flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9a2 2 0 0 0-2 2v2.5a2.5 2.5 0 0 0 5 0V11a2 2 0 0 0-2-2z"/><path d="M12 9V4"/><path d="m15 6-3-3-3 3"/></svg>
                                Heater Status
                            </span>
                            <div class="flex items-center gap-2">
                                <svg id="heater-status-icon" class="text-gray-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v6"/><path d="M12 12l3.5 3.5"/><path d="M12 12H6"/><path d="M12 12l-3.5 3.5"/><circle cx="12" cy="12" r="10"/></svg>
                                <span id="heater-status-text" class="font-semibold text-gray-400">OFF</span>
                            </div>
                        </div>
                    </div>
                     <button id="feed-now-btn" class="w-full mt-6 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed border border-cyan-400">
                        Feed Now
                    </button>
                </div>

                <!-- History Chart -->
                <div class="bg-glass p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-gray-200">Sensor History</h2>
                    <div class="h-64">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Lighting & Logs Column -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- Lighting Control -->
                <div class="bg-glass p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-gray-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 18a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6c0 2.06-1.09 3.88-2.73 4.97"/><path d="M12 22v-2"/><path d="M12 6V4"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 19.07 1.41-1.41"/><path d="m17.66 6.34 1.41-1.41"/></svg>
                        Lighting
                    </h2>
                    <div>
                        <label for="light-intensity" class="block mb-2 text-sm font-medium text-gray-400">Intensity: <span id="light-intensity-value">50</span>%</label>
                        <input id="light-intensity" type="range" min="0" max="100" value="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                     <div class="mt-4">
                        <label for="light-color" class="block mb-2 text-sm font-medium text-gray-400">Color Temp: <span id="light-color-value">4500</span>K</label>
                        <input id="light-color" type="range" min="2700" max="6500" value="4500" step="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                <!-- System Log -->
                <div class="bg-glass p-4 rounded-xl shadow-lg flex-grow">
                    <h2 class="text-lg font-semibold text-gray-200 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5"/><path d="M14 3h7v7"/><path d="M14 10.5 21 3.5"/></svg>
                        System Log
                    </h2>
                    <div id="log-container" class="h-48 overflow-y-auto bg-black bg-opacity-25 rounded-md p-2 text-sm font-mono text-gray-300">
                        <!-- Log messages will appear here -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Feed Confirmation Modal -->
    <div id="feed-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-overlay">
        <div class="bg-glass-darker rounded-xl shadow-2xl p-6 w-full max-w-sm modal-container scale-95">
            <h2 class="text-xl font-bold text-white mb-4">Confirm Feeding</h2>
            <p class="text-gray-300 mb-6">Are you sure you want to dispense one serving of food now?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-feed-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg transition">Cancel</button>
                <button id="confirm-feed-btn" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg transition">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Robust error handling for the entire script
            try {
                let websocket;
                const MAX_HISTORY = 30;

                // --- Element References ---
                const tempValue = document.getElementById('temp-value');
                const phValue = document.getElementById('ph-value');
                const tdsValue = document.getElementById('tds-value');
                const ammoniaValue = document.getElementById('ammonia-value');
                const waterLevel = document.getElementById('water-level');
                const heaterStatusIcon = document.getElementById('heater-status-icon');
                const heaterStatusText = document.getElementById('heater-status-text');
                const connectionStatusDiv = document.getElementById('connection-status');
                const logContainer = document.getElementById('log-container');
                const reconnectBtn = document.getElementById('reconnect-btn');
                
                const pumpToggle = document.getElementById('pump-toggle');
                const feederToggle = document.getElementById('feeder-toggle');
                const feedNowBtn = document.getElementById('feed-now-btn');
                const lightIntensitySlider = document.getElementById('light-intensity');
                const lightIntensityValue = document.getElementById('light-intensity-value');
                const lightColorSlider = document.getElementById('light-color');
                const lightColorValue = document.getElementById('light-color-value');

                const feedModal = document.getElementById('feed-modal');
                const confirmFeedBtn = document.getElementById('confirm-feed-btn');
                const cancelFeedBtn = document.getElementById('cancel-feed-btn');

                let tempGauge, phGauge, historyChart;
                const historyData = { labels: [], temp: [], ph: [] };

                // --- WebSocket Connection ---
                function connectWebSocket() {
                    const esp32_ip = "192.168.1.100"; 
                    logMessage(`Attempting to connect to ws://${esp32_ip}/ws...`);
                    
                    // --- SIMULATION START ---
                    setTimeout(() => {
                        websocket = {
                            send: (message) => logMessage(`SIMULATED SEND: ${message}`),
                            close: () => { 
                                logMessage('SIMULATED: Connection closed.');
                                onClose();
                            },
                            readyState: 1
                        };
                        onOpen();
                        setInterval(simulateDataReception, 3000);
                    }, 1000);
                    // --- SIMULATION END ---

                    /* --- REAL WEBSOCKET EVENTS ---
                    websocket = new WebSocket(`ws://${esp32_ip}/ws`);
                    websocket.onopen = onOpen;
                    websocket.onclose = onClose;
                    websocket.onmessage = onMessage;
                    websocket.onerror = onError;
                    */
                }

                function onOpen(event) {
                    logMessage('Connection established!');
                    connectionStatusDiv.innerHTML = `<div class="w-3 h-3 rounded-full bg-green-500"></div><span class="text-gray-300">Connected</span>`;
                    reconnectBtn.textContent = 'Disconnect';
                    sendMessage({ action: 'getState' });
                }

                function onClose(event) {
                    logMessage('Connection closed.');
                    connectionStatusDiv.innerHTML = `<div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div><span class="text-gray-400">Disconnected</span>`;
                    reconnectBtn.textContent = 'Connect';
                    websocket = null;
                }
                
                function onMessage(event) {
                    logMessage(`Received: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        updateDashboard(data);
                    } catch (e) {
                        logMessage(`Error parsing JSON: ${e}`);
                    }
                }

                function onError(event) {
                    logMessage('WebSocket error observed:', event);
                }

                function sendMessage(data) {
                    if (websocket && websocket.readyState === 1) {
                        const message = JSON.stringify(data);
                        websocket.send(message);
                        logMessage(`Sent: ${message}`);
                    } else {
                        logMessage('Cannot send message. WebSocket is not connected.');
                    }
                }
                
                reconnectBtn.addEventListener('click', () => {
                    if (!websocket || websocket.readyState === 3) {
                        connectWebSocket();
                    } else {
                        websocket.close();
                    }
                });

                // --- Dashboard Update Logic ---
                function updateDashboard(data) {
                    const now = new Date();
                    const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                    if (data.temperature !== undefined) {
                        const temp = parseFloat(data.temperature);
                        tempValue.textContent = temp.toFixed(1);
                        updateGauge(tempGauge, temp, tempGauge.config.options.plugins.gauge.range);
                        updateHistory(timestamp, temp, null);
                    }
                    if (data.ph !== undefined) {
                        const ph = parseFloat(data.ph);
                        phValue.textContent = ph.toFixed(1);
                        updateGauge(phGauge, ph, phGauge.config.options.plugins.gauge.range);
                        updateHistory(timestamp, null, ph);
                    }
                    if (data.tds !== undefined) {
                        tdsValue.textContent = data.tds;
                    }
                    if (data.ammonia !== undefined) {
                        const nh3 = parseFloat(data.ammonia);
                        ammoniaValue.textContent = nh3.toFixed(2);
                        ammoniaValue.parentElement.classList.remove('text-green-400', 'text-yellow-400', 'text-red-500');
                        if (nh3 < 0.25) ammoniaValue.parentElement.classList.add('text-green-400');
                        else if (nh3 < 1.0) ammoniaValue.parentElement.classList.add('text-yellow-400');
                        else ammoniaValue.parentElement.classList.add('text-red-500');
                    }
                    if (data.waterLevel !== undefined) {
                        waterLevel.textContent = data.waterLevel ? 'OK' : 'LOW';
                        waterLevel.classList.toggle('text-red-500', !data.waterLevel);
                        waterLevel.classList.toggle('text-cyan-300', data.waterLevel);
                    }
                    if (data.heaterOn !== undefined) {
                        heaterStatusText.textContent = data.heaterOn ? 'ON' : 'OFF';
                        heaterStatusIcon.classList.toggle('text-orange-400', data.heaterOn);
                        heaterStatusIcon.classList.toggle('text-gray-500', !data.heaterOn);
                        heaterStatusText.classList.toggle('text-orange-400', data.heaterOn);
                        heaterStatusText.classList.toggle('text-gray-400', !data.heaterOn);
                    }
                    if (data.pumpOn !== undefined) pumpToggle.checked = data.pumpOn;
                    if (data.feederOn !== undefined) feederToggle.checked = data.feederOn;
                    if (data.lightIntensity !== undefined) {
                        lightIntensitySlider.value = data.lightIntensity;
                        lightIntensityValue.textContent = data.lightIntensity;
                    }
                     if (data.lightColor !== undefined) {
                        lightColorSlider.value = data.lightColor;
                        lightColorValue.textContent = data.lightColor;
                    }
                }

                // --- Event Listeners for Controls ---
                pumpToggle.addEventListener('change', () => sendMessage({ action: 'setPump', value: pumpToggle.checked }));
                feederToggle.addEventListener('change', () => sendMessage({ action: 'setFeeder', value: feederToggle.checked }));
                lightIntensitySlider.addEventListener('input', () => lightIntensityValue.textContent = lightIntensitySlider.value);
                lightIntensitySlider.addEventListener('change', () => sendMessage({ action: 'setLightIntensity', value: parseInt(lightIntensitySlider.value) }));
                lightColorSlider.addEventListener('input', () => lightColorValue.textContent = lightColorSlider.value);
                lightColorSlider.addEventListener('change', () => sendMessage({ action: 'setLightColor', value: parseInt(lightColorSlider.value) }));

                // --- Modal Logic ---
                feedNowBtn.addEventListener('click', () => {
                    feedModal.classList.remove('hidden');
                    setTimeout(() => {
                        feedModal.querySelector('.modal-overlay').classList.remove('opacity-0');
                        feedModal.querySelector('.modal-container').classList.remove('scale-95');
                    }, 10);
                });

                function closeModal() {
                    feedModal.querySelector('.modal-overlay').classList.add('opacity-0');
                    feedModal.querySelector('.modal-container').classList.add('scale-95');
                    setTimeout(() => feedModal.classList.add('hidden'), 300);
                }

                cancelFeedBtn.addEventListener('click', closeModal);
                confirmFeedBtn.addEventListener('click', () => {
                    sendMessage({ action: 'feedNow' });
                    closeModal();
                    feedNowBtn.disabled = true;
                    feedNowBtn.textContent = 'Feeding...';
                    setTimeout(() => {
                        feedNowBtn.disabled = false;
                        feedNowBtn.textContent = 'Feed Now';
                    }, 5000);
                });

                // --- Logging ---
                function logMessage(message) {
                    if(logContainer) {
                        const now = new Date();
                        const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                        const logEntry = document.createElement('div');
                        logEntry.innerHTML = `<span class="text-gray-500">${timestamp} ></span> ${message}`;
                        logContainer.appendChild(logEntry);
                        logContainer.scrollTop = logContainer.scrollHeight;
                    } else {
                        console.log(message);
                    }
                }

                // --- Chart & Gauge Creation ---
                function initializeCharts() {
                    try {
                        const tempColorStops = [[0, [52, 144, 220]], [0.5, [107, 204, 107]], [1, [220, 52, 52]]];
                        const phColorStops = [[0, [220, 52, 52]], [0.5, [107, 204, 107]], [1, [138, 43, 226]]];
                        tempGauge = createGauge('tempGauge', 'Temperature', [10, 40], tempColorStops);
                        phGauge = createGauge('phGauge', 'pH', [5, 9], phColorStops);
                        const ctx = document.getElementById('historyChart').getContext('2d');
                        historyChart = new Chart(ctx, {
                            type: 'line',
                            data: { labels: historyData.labels, datasets: [ { label: 'Temp (Â°C)', data: historyData.temp, borderColor: 'rgba(52, 211, 153, 1)', backgroundColor: 'rgba(52, 211, 153, 0.1)', yAxisID: 'y', tension: 0.3, fill: true, }, { label: 'pH', data: historyData.ph, borderColor: 'rgba(34, 211, 238, 1)', backgroundColor: 'rgba(34, 211, 238, 0.1)', yAxisID: 'y1', tension: 0.3, fill: true, } ] },
                            options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#9CA3AF' }, grid: { color: '#4B5563' } }, y: { type: 'linear', display: true, position: 'left', min: 15, max: 35, ticks: { color: '#9CA3AF' }, grid: { color: '#4B5563' } }, y1: { type: 'linear', display: true, position: 'right', min: 6, max: 8, ticks: { color: '#9CA3AF' }, grid: { drawOnChartArea: false } } }, plugins: { legend: { labels: { color: '#D1D5DB' } } } }
                        });
                    } catch (e) {
                         console.error("A critical error occurred while initializing charts:", e);
                         throw e; // Re-throw the error to be caught by the outer block
                    }
                }

                function createGauge(canvasId, label, range, colorStops) {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    return new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [0, range[1] - range[0]], backgroundColor: [colorStops[1], '#4A5568'], borderWidth: 0, circumference: 180, rotation: 270 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { tooltip: { enabled: false }, legend: { display: false }, gauge: { range, colorStops } }, animation: { duration: 500, easing: 'easeOutQuart' } } });
                }

                function updateGauge(gauge, value, range) {
                    const [min, max] = range;
                    const percentage = (value - min) / (max - min);
                    const color = getColorForPercentage(percentage, gauge.config.options.plugins.gauge.colorStops);
                    gauge.data.datasets[0].data[0] = value - min;
                    gauge.data.datasets[0].data[1] = max - value;
                    gauge.data.datasets[0].backgroundColor[0] = color;
                    gauge.update();
                }
                
                function updateHistory(label, temp, ph) {
                    if (historyData.labels.length >= MAX_HISTORY) {
                        historyData.labels.shift();
                        historyData.temp.shift();
                        historyData.ph.shift();
                    }
                    historyData.labels.push(label);
                    historyData.temp.push(temp);
                    historyData.ph.push(ph);
                    historyChart.update();
                }

                function getColorForPercentage(pct, colorStops) {
                     for (let i = 1; i < colorStops.length; i++) {
                        if (pct <= colorStops[i][0]) {
                            const lower = colorStops[i - 1];
                            const upper = colorStops[i];
                            const rangePct = (pct - lower[0]) / (upper[0] - lower[0]);
                            return interpolateColor(lower[1], upper[1], rangePct);
                        }
                    }
                    return `rgb(${colorStops[colorStops.length - 1][1].join(',')})`;
                }

                function interpolateColor(c1, c2, f) {
                    let r = Math.round(c1[0] + f * (c2[0] - c1[0]));
                    let g = Math.round(c1[1] + f * (c2[1] - c1[1]));
                    let b = Math.round(c1[2] + f * (c2[2] - c1[2]));
                    return `rgb(${r},${g},${b})`;
                }
                
                // --- Mock Data Simulation ---
                function simulateDataReception() {
                    const temp = (24 + Math.random() * 4);
                    const mockData = {
                        temperature: temp.toFixed(1),
                        ph: (6.8 + Math.random() * 0.4).toFixed(1),
                        tds: Math.floor(120 + Math.random() * 60),
                        ammonia: (Math.random() * 0.5).toFixed(2),
                        waterLevel: Math.random() > 0.1,
                        heaterOn: temp < 25.5,
                    };
                    logMessage(`SIMULATED RECV: ${JSON.stringify(mockData)}`);
                    updateDashboard(mockData);
                }
                
                // --- Initialization ---
                logMessage("Dashboard initialized. Waiting for connection.");
                initializeCharts();

            } catch (e) {
                console.error("A critical error occurred during initialization:", e);
                const container = document.getElementById('dashboard-container');
                if(container) {
                    container.innerHTML = `<div style="color: white; background: rgba(0,0,0,0.7); border-radius: 8px; padding: 20px; margin: 20px;">
                        <h1 style="font-size: 1.5rem; color: #ff4d4d; margin-bottom: 1rem;">Dashboard Failed to Load</h1>
                        <p style="margin-bottom: 0.5rem;">A critical JavaScript error prevented the application from starting. Please check the developer console (F12) for more details.</p>
                        <p style="font-weight: bold; color: #ffaeae;">Error Message:</p>
                        <pre style="color: #ffaeae; background: #333; padding: 10px; border-radius: 5px; white-space: pre-wrap; word-break: break-all;">${e.stack}</pre>
                    </div>`;
                }
            }
        });
    </script>

</body>
</html>
